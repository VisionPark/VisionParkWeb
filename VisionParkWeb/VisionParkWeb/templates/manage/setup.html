{% extends 'adminlte/base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="/static/drawerJs/dist/drawerJs.css"/>
<style>
    #canvas-editor {
        margin-top: 50px;
        margin-left: 50px;
    }
</style>
{% endblock %}

{% load i18n %}

{% block title %}{% trans 'Setup' %}{% endblock %}

{% block content %}

<div id="canvas-editor" style="margin-right: auto;"></div>
        
        <script src="/static/drawerJs/dist/jquery-3.4.1.min.js"></script>
        <script src="/static/drawerJs/dist/drawerJs.standalone.js"></script>
        <script src="/static/drawerJs/drawerLocalization.js"></script>
        <script src="/static/drawerJs/drawerJsConfig.js"></script>

        <script>

            var drawer = null;
            var canvasWidth = $(document).width()*0.75;
            var canvasHeight = $(document).height()*0.75;
            var difX = 1280 / canvasWidth;
            var difY = 720 / canvasHeight;


            function buildTable(canvasId, canvasData) {
                //var canvasJson = JSON.stringify(canvasData);
                console.log(canvasData);

                var data = JSON.parse(canvasData)
                var table = document.getElementById('myTable')
                table.innerHTML = "";
               

                for (i in data.objects){

                    var obj = data.objects[i];

                    if(obj.type == "segmentablePolygon"){
                        var row = "<tr>"
                
                        var centerX = parseFloat(obj.left); //Absolute position of upper left vertex
                        var centerY = parseFloat(obj.top);
                        var scaleX = parseFloat(obj.scaleX);
                        var scaleY = parseFloat(obj.scaleY);
                        var sizeX = parseFloat(data.backgroundImage.width);
                        var sizeY = parseFloat(data.backgroundImage.height);

                        // Setting stroke
                        // obj.stroke = "#1f497d",
                        // obj.strokeWidth = 5,
                        // obj.strokeDashArray = [8,8]

                        //console.log(centerX/sizeX*1280, centerY/sizeY*720)


                        for(j in obj.points[0]){
                           point = obj.points[0][j]
                        
                           /* Set centerXY to the actual center of the polygon
                                Translate upper left vertex to the center 
                           */
                           if(j==0){
                            console.log("CenterX: "+centerX + " ; CenterY: "+ centerY)
                            console.log("V1X: "+point.x + " ; V2Y: "+ point.y)
                            
                            centerX = centerX +  Math.abs(point.x)
                            centerY = centerY +  Math.abs(point.y)

                            console.log("New CenterX: "+centerX / sizeX *1280 + " ; CenterY: "+ centerY / sizeY *720)
                           }
                           
                            x = (parseFloat(point.x) + centerX)  / sizeX * 1280
                            y = (parseFloat(point.y) + centerY) / sizeY  * 720                

                            row += "<td>["+x + " , " + y+"]</td>";

                        }
                        row += "</tr>"
                        table.innerHTML += row
                     }
                    
                }
            } //buildTable

            var drawerPlugins = [
                'BackgroundImage',
                'Polygon',
                'ShapeContextMenu',
                'Zoom',
                
                ];

            $(document).ready(function () {
                    drawer = new DrawerJs.Drawer(null, {
                    texts: customLocalization,
                    align: 'center',
                    plugins: drawerPlugins,
                    defaultImageUrl: '/static/drawerJS/play-button.png', // Click to start
                    defaultActivePlugin : { name : 'Polygon', mode : 'lastUsed'},
                    activeColor: 'rgba(0, 255, 255, 0.55)',
                    pluginsConfig: {
                        BackgroundImage: {
                            scaleDownLargeImage: true,
                            imagePosition: 'stretch',
                            dynamicRepositionImage: true,
                            dynamicRepositionImageThrottle: 100,
                            fixedBackgroundUrl: '/static/drawerJS/parking_sample.jpg',
                        },
                        ShapeBorder: {
                            color: '#F3060A',
                            defaultBorder:  'Dashed bold'
                        },
                        Color: {
                            colors: []
                        }
                    },
                    contentConfig: {
                        saveCanvasData:buildTable,
                        
                    },

                }, canvasWidth, canvasHeight);
                $('#canvas-editor').append(drawer.getHtml());
                
            
                drawer.onInsert();
                drawer.api.startEditing();
                
            });


            function saveCanvas(){
                localStorage.setItem('canvasData', JSON.stringify(drawer.getCanvasData()));

                $(document).ready(function () {
                    drawer2 = new DrawerJs.Drawer(null, {
                        texts: customLocalization,
                        plugins: drawerPlugins,
                        defaultImageUrl: '/static/drawerJS/play-button.png', // Click to start
                        defaultActivePlugin : { name : 'Polygon', mode : 'lastUsed'},
                        pluginsConfig: {
                            BackgroundImage: {
                                scaleDownLargeImage: true,
                                imagePosition: 'stretch',
                                dynamicRepositionImage: true,
                                dynamicRepositionImageThrottle: 100,
                                fixedBackgroundUrl: '/static/drawerJS/parking_sample.jpg',
                            }
                        },

                    }, canvasWidth, canvasHeight);
                    $('#canvas-editor').append(drawer2.getHtml());
                    
                
                    drawer2.onInsert();
                    drawer2.api.startEditing();
                    drawer2.loadCanvas(localStorage.getItem('canvasData'));
                    
                });
                console.log(localStorage.getItem('canvasData'))
            }

    </script>

<div class="col-9" style="margin-top: 3%; margin-left: auto; margin-right: auto;">
    <!-- <p>
        <button id="saveCanvas" onclick="saveCanvas()">{% trans 'Save parking setup' %}</button>
    </p> -->
    <table class="table table-striped">
        <tr  class="bg-info">
            <th>V1</th>
            <th>V2</th>
            <th>V3</th>
            <th>V4</th>
        </tr>

        <tbody id="myTable">
            
        </tbody>
    </table>
</div>

{% endblock %}